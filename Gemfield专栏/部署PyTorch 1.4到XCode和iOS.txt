èƒŒæ™¯
æœ€è¿‘éœ€è¦å°†ä¸€ä¸ªæ¨¡å‹è¿è¡Œåœ¨iOSè®¾å¤‡ä¸Šã€‚ä¸€å¹´å‰ï¼ŒGemfieldè¿˜åœ¨PyTorch 1.0ä¸Šå·¥ä½œçš„æ—¶å€™ï¼ŒGemfieldå·²ç»åšè¿‡è¿™ä¸ªäº‹æƒ…ï¼Œå…ˆåæœ‰å‡ ä¸ªç›¸å…³çš„PRä¹Ÿè¢«mergeåˆ°å®˜æ–¹ä»“åº“äº†ï¼Œå¹¶ä¸”ä¹Ÿå†™äº†è¿™ç¯‡ä¸“æ æ–‡ç« ï¼š
Gemfieldï¼šéƒ¨ç½²PyTorchåˆ°iOSä¸Š
â€‹zhuanlan.zhihu.com/p/60563168
ä½†æ˜¯ï¼ŒPyTorch 1.3ä¹‹åï¼Œæœ‰äº›å†…å®¹å°±è¿‡æ—¶äº†ã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚ä»Šéƒ¨ç½²PyTorchæ¨¡å‹åˆ°iOSä¸Šä¾ç„¶æœ‰2ç§æ–¹æ³•ï¼š
1ï¼ŒPyTorch -> ONNX -> CoreML -> iOS
è¿™ä¸ªæµç¨‹æ²¡æœ‰è¿‡æ—¶ï¼Œä¾æ—§å‚è€ƒGemfieldä¸“æ æ–‡ç« ï¼ˆè™½ç„¶è¯¥ç¯‡æ–‡ç« ä¹Ÿå‡†å¤‡æ›´æ–°ä¸‹ï¼‰ï¼š
Gemfieldï¼šéƒ¨ç½²PyTorchæ¨¡å‹åˆ°ç»ˆç«¯
276 èµåŒ Â· 35 è¯„è®ºæ–‡ç« 

2ï¼ŒPyTorch -> iOS
ä¹Ÿå°±æ˜¯ç›´æ¥ç¼–è¯‘PyTorchçš„æ¨ç†æ¡†æ¶æˆä¸ºiOSä¸Šçš„é™æ€åº“ï¼Œè‡ªç„¶PyTorchçš„æ¨¡å‹å°±èƒ½ç›´æ¥åœ¨iOSä¸Šè¢«è§£ææ‰§è¡Œäº†ã€‚å’Œä¸Šæ¬¡çš„ä¸“æ æ–‡ç« ç›¸æ¯”ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œæœ¬æ–‡ä¸­ï¼ŒGemfieldå°±æ¥è¯¦ç»†è§£é‡Šä¸‹è¿™äº›å˜åŒ–ã€‚
iOSä¸ŠPyTorchåº“çš„å˜åŒ–
åˆ°äº†PyTorch1.3ï¼ŒPyTorchå¯¹iOSå’ŒAndroidçš„æ”¯æŒæ›´å‹å¥½äº†ï¼Œä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
TorchScriptæˆç†Ÿäº†ï¼Œé€šè¿‡jitå°†æ¨¡å‹åºåˆ—åŒ–ï¼Œæ‘†è„±å¯¹Pythonå¯¹ä¾èµ–ï¼Œæé«˜è¿è¡Œæ—¶çš„æ•ˆç‡ï¼›
æä¾›äº†æ‰‹æœºAppä¸­MLéƒ¨åˆ†ç»å¸¸éœ€è¦ç”¨åˆ°çš„é¢„å¤„ç†å’Œå·¥ç¨‹é›†æˆAPIï¼›
æ”¯æŒARM CPUæ¶æ„ä¸Šçš„QNNPACK quantized kernel librariesï¼›
ç¼–è¯‘å±‚é¢çš„ä¼˜åŒ–ï¼Œæ”¯æŒè‡ªå®šä¹‰éœ€è¦ç¼–è¯‘çš„operatorï¼›
åœ¨ç§»åŠ¨ç«¯çš„CPUå’ŒGPUä¸Šè¿›ä¸€æ­¥åšäº†æ€§èƒ½ä¼˜åŒ–ã€‚
å¥½äº†ï¼Œå½“æˆ‘ä»¬å‡†å¤‡å¥½åœ¨Xcodeä¸Šä½¿ç”¨PyTorchåº“çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼šPodå®‰è£…å’Œè‡ªå·±ç¼–è¯‘ã€‚
ä½¿ç”¨Podå®‰è£…PyTorchåº“åˆ°Xcode
Podæ˜¯cocoapodsçš„å‘½ä»¤ï¼Œcocoapodsæ˜¯iOSå¼€å‘ä¸­ä¸‰æ–¹åº“çš„è‡ªåŠ¨ç®¡ç†å·¥å…·ã€‚ä½¿ç”¨Podæ¥å®‰è£…PyTorchåº“åˆ°Xcodeçš„æ–¹æ³•å¦‚ä¸‹ï¼š
#å®‰è£…Pod
sudo gem install cocoapods

#åœ¨Xcodeé¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºç©ºçš„podæ–‡ä»¶
pod init
ç»è¿‡pod initåï¼ŒPodfileæ–‡ä»¶ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ç”Ÿæˆã€‚æ‰“å¼€Podfileï¼Œåœ¨æ–‡ä»¶ä¸­æ·»åŠ ï¼š
platform :ios, '12.0'
target 'SYSZUXcv7' do
  pod 'LibTorch', '~>1.4.0'
end
å…¶ä¸­ï¼Œplatformã€targetã€LibTorchçš„ç‰ˆæœ¬æŒ‰ç…§è‡ªå·±çš„å®é™…ä¿®æ”¹ã€‚
ç„¶åæ‰§è¡ŒPodçš„å®‰è£…å‘½ä»¤ï¼š
Pod install
è¿™ä¸ªè¿‡ç¨‹ä¼šä¸‹è½½LibTorchåº“ï¼Œå¹¶ä¸”ä¼šä¿®æ”¹Xcodeçš„é¡¹ç›®æ–‡ä»¶ï¼ˆå¦‚project.pbxprojç­‰ï¼‰ï¼Œè¿™æ ·å½“ä½ ä¸‹æ¬¡æ‰“å¼€è¯¥Xcodeé¡¹ç›®åï¼Œä½ ä¼šå‘ç°PyTorchçš„ä¾èµ–å·²ç»è‡ªåŠ¨é…ç½®åˆ°é¡¹ç›®ä¸­äº†ã€‚
åœ¨Xcodeä¸­é‡æ–°æ‰“å¼€è¯¥é¡¹ç›®ï¼šç‚¹å‡»SYSZUXcv7.xcworkspaceã€‚
ä¸Šè¿°Podå®‰è£…çš„PyTorchå®˜æ–¹åº“æ˜¯å¦‚ä½•ç¼–è¯‘çš„ï¼Ÿ
PyTorchå®˜æ–¹æ˜¯å¦‚ä½•ç¼–è¯‘Podä¸­ç»´æŠ¤çš„iOSåº“å‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨å…ˆçœ‹çœ‹å®˜æ–¹çš„CIç³»ç»Ÿæ˜¯å¦‚ä½•åšçš„ã€‚åœ¨circleciçš„config.yamlä¸­ï¼š
- binary_ios_build:
    name: pytorch_ios_11_2_1_nightly_x86_64_build
    build_environment: "libtorch-ios-11.2.1-nightly-x86_64-build"
    context: org-member
    ios_platform: "SIMULATOR"
    ios_arch: "x86_64"
    requires: 
      - setup

- binary_ios_build:
    name: pytorch_ios_11_2_1_nightly_arm64_build
    build_environment: "libtorch-ios-11.2.1-nightly-arm64-build"
    context: org-member
    ios_arch: "arm64"
    ios_platform: "OS"
    requires: 
      - setup

- binary_ios_upload:
    build_environment: "libtorch-ios-11.2.1-nightly-binary-build-upload"
    context: org-member
    requires:
      - setup
      - pytorch_ios_11_2_1_nightly_x86_64_build
      - pytorch_ios_11_2_1_nightly_arm64_build
åœ¨workerflowä¸­è®¾ç½®çš„jobï¼Œå†…å®¹å¦‚ä¸‹ï¼š
binary_ios_build:
  <<: *pytorch_ios_params
  macos:
    xcode: "11.2.1"
  steps:
  - run_brew_for_ios_build
  - run:
      command: |
        script="/Users/distiller/project/.circleci/scripts/binary_ios_build.sh"
        source "$script"
  - run:
      command: |
        script="/Users/distiller/project/.circleci/scripts/binary_ios_test.sh"
        source "$script"

binary_ios_upload:
  <<: *pytorch_ios_params
  macos:
    xcode: "11.2.1"
  steps:
  - run_brew_for_ios_build
  - run:
      command: |
        script="/Users/distiller/project/.circleci/scripts/binary_ios_upload.sh"
        source "$script"
ä½ ä¸éœ€è¦çœ‹ä¸Šé¢çš„ç»†èŠ‚å†…å®¹ï¼ŒGemfieldç›´æ¥ç»™ä½ æ€»ç»“å‡ºæ¥ï¼š
1ï¼Œåœ¨macOSä¸Šå‡çº§brew
for path in $(find /usr/local/Homebrew -type d -name .git)
do
cd $path/..
git fetch --depth=1 origin
git reset --hard origin/master
done

export HOMEBREW_NO_AUTO_UPDATE=1
brew unlink parallel
brew install moreutils
brew link parallel --overwrite
brew install expect
2ï¼Œå®‰è£…libtool
export HOMEBREW_NO_AUTO_UPDATE=1
brew install libtool
3ï¼Œæ‰§è¡Œ.circleci/scripts/binary_ios_build.sh
è¿™ä¸ªè„šæœ¬é‡Œçš„ä¸»è¦å·¥ä½œæœ‰ğŸ‘‡è¿™äº›å†…å®¹ï¼š
å®‰è£…condaåŠpythonåŒ…ä¾èµ–ï¼š
conda install numpy ninja pyyaml mkl mkl-include setuptools cmake cffi typing requests --yes
export CMAKE_PREFIX_PATH=${CONDA_PREFIX:-"$(dirname $(which conda))/../"}
æ›´æ–°pytorchåº“ï¼š
cd ${PROJ_ROOT}
git submodule sync
git submodule update --init --recursive
è¿è¡Œbuildè„šæœ¬ï¼š
chmod a+x ${PROJ_ROOT}/scripts/build_ios.sh
echo "IOS_ARCH: ${IOS_ARCH}"
echo "IOS_PLATFORM: ${IOS_PLATFORM}"
export BUILD_PYTORCH_MOBILE=1
export IOS_ARCH=${IOS_ARCH}
export IOS_PLATFORM=${IOS_PLATFORM}

#tså‘½ä»¤æ˜¯moreutilsåŒ…ä¸­çš„ï¼Œç”¨æ¥å°†è¾“å‡ºçš„æ¯ä¸€è¡Œä¿¡æ¯åŠ ä¸Šæ—¶é—´æˆ³
unbuffer ${PROJ_ROOT}/scripts/build_ios.sh 2>&1 | ts
ä¿å­˜ç¼–è¯‘äº§ç‰©ï¼š
cd ${WORKSPACE}
DEST_DIR=${WORKSPACE}/ios
mkdir -p ${DEST_DIR}
cp -R ${PROJ_ROOT}/build_ios/install ${DEST_DIR}
mv ${DEST_DIR}/install ${DEST_DIR}/${IOS_ARCH}
4ï¼Œæ‰§è¡Œ.circleci/scripts/binary_ios_test.sh
è¿™ä¸ªè„šæœ¬çš„ä¸»è¦å·¥ä½œå°±æ˜¯ä½¿ç”¨ä¸Šè¿°ç¼–è¯‘å¥½çš„pytorchåº“æ¥ç¼–è¯‘TestAppï¼Œå…·ä½“æ­¥éª¤æœ‰ï¼š
å®‰è£…bundleã€fastlaneã€è¯ä¹¦ï¼š
ROJ_ROOT=/Users/distiller/project
cd ${PROJ_ROOT}/ios/TestApp
sudo gem install bundler && bundle install
echo "${IOS_CERT_KEY}" >> cert.txt
base64 --decode cert.txt -o Certificates.p12
rm cert.txt
bundle exec fastlane install_cert
å®‰è£…provisioning profileï¼š
PROFILE=TestApp_CI.mobileprovision
PROVISIONING_PROFILES=~/Library/MobileDevice/Provisioning\ Profiles
mkdir -pv "${PROVISIONING_PROFILES}"
cd "${PROVISIONING_PROFILES}"
echo "${IOS_SIGN_KEY}" >> cert.txt
base64 --decode cert.txt -o ${PROFILE}
rm cert.txt
ç»è¿‡è¿™ä¸€æ­¥åï¼Œåœ¨macOSä¸Šçš„~/Library/MobileDevice/Provisioning\ Profiles/ ç›®å½•ä¸‹ä¼šæœ‰ï¼š
civilnet:~/CivilNet/pytorch$ ls -l ~/Library/MobileDevice/Provisioning\ Profiles/
total 192
-rw-r--r--  1 civilnet  staff  9367  2 21 17:03 0c5b98b7-710d-4b90-973c-b22d3fd8f096.mobileprovision
-rw-r--r--  1 civilnet  staff  9367  2 19 23:57 68e237fa-9e1f-4684-958a-63d8378f40f0.mobileprovision
-rw-r--r--  1 civilnet  staff  9367  2 19 23:41 TestApp_CI.mobileprovision
ruby buildæ¥ç¼–è¯‘iOS Appï¼š
PROFILE=TestApp_CI
ruby ${PROJ_ROOT}/scripts/xcode_build.rb \
-i ${PROJ_ROOT}/build_ios/install \
-x ${PROJ_ROOT}/ios/TestApp/TestApp.xcodeproj \
-p ${IOS_PLATFORM} -c ${PROFILE} -t ${IOS_DEV_TEAM_ID}
è¿™äº›å‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š
-iå‚æ•°ä¸ºpytorchçš„cmakeå®‰è£…è·¯å¾„;
-xä¸ºXCodeé¡¹ç›®æ–‡ä»¶;
-pä¸ºå½“å‰ç¼–è¯‘çš„platform(OSæˆ–è€…æ¨¡æ‹Ÿå™¨);
-cå‚æ•°ä¸ºcode signingçš„provisioning profile;
-tå‚æ•°ä¸ºdevelopment team IDã€‚
scripts/xcode_build.rbä¸ºpytorchä»“åº“ä¸­çš„rubyæ–‡ä»¶ï¼Œæœ€åè°ƒç”¨äº†xcodebuildå‘½ä»¤ï¼š
xcodebuild clean build  -project #{xcodeproj_path}  \
-target #{target.name} -sdk #{sdk} \
-configuration Release PROVISIONING_PROFILE_SPECIFIER=#{profile}
5ï¼Œæ‰§è¡Œ.circleci/scripts/binary_ios_upload.sh
å¦‚æœå‰è¿°ç¼–è¯‘æ²¡æœ‰é—®é¢˜çš„è¯ï¼Œè¿™ä¸ªè„šæœ¬ä¼šå°†ç¼–è¯‘äº§ç‰©æ‰“åŒ…ä¸ºcocoapodä¸­çš„zipåŒ…ã€‚å…·ä½“æ­¥éª¤æœ‰ï¼š
æ‹·è´å¤´æ–‡ä»¶ï¼š
WORKSPACE=/Users/distiller/workspace
PROJ_ROOT=/Users/distiller/project
ARTIFACTS_DIR=${WORKSPACE}/ios
ls ${ARTIFACTS_DIR}
ZIP_DIR=${WORKSPACE}/zip
mkdir -p ${ZIP_DIR}/install/lib
mkdir -p ${ZIP_DIR}/src
# copy header files
cp -R ${ARTIFACTS_DIR}/arm64/include ${ZIP_DIR}/install/
æ‹·è´.aæ–‡ä»¶ï¼Œé™¤äº†nnpackåªæœ‰arm64æ¶æ„å¤–ï¼Œå…¶å®ƒçš„.aåº“éƒ½ç”¨lipoå‘½ä»¤å°†ä¸åŒæ¶æ„çš„æ‰“åŒ…åˆ°ä¸€èµ·ï¼š
# build a FAT bianry
cd ${ZIP_DIR}/install/lib
target_libs=(libc10.a libclog.a libcpuinfo.a libeigen_blas.a libpytorch_qnnpack.a libtorch_cpu.a libtorch.a libXNNPACK.a)
for lib in ${target_libs[*]}
do
    if [ -f "${ARTIFACTS_DIR}/x86_64/lib/${lib}" ] && [ -f "${ARTIFACTS_DIR}/arm64/lib/${lib}" ]; then
        libs=("${ARTIFACTS_DIR}/x86_64/lib/${lib}" "${ARTIFACTS_DIR}/arm64/lib/${lib}")
        lipo -create "${libs[@]}" -o ${ZIP_DIR}/install/lib/${lib}
    fi
done
# for nnpack, we only support arm64 build
cp ${ARTIFACTS_DIR}/arm64/lib/libnnpack.a ./
lipo -i ${ZIP_DIR}/install/lib/*.a
æ‹·è´umbrella header å’Œ licenseæ–‡ä»¶ï¼š
cp ${PROJ_ROOT}/ios/LibTorch.h ${ZIP_DIR}/src/
cp ${PROJ_ROOT}/LICENSE ${ZIP_DIR}/
å°†æ‰€æœ‰çš„.hæ–‡ä»¶ã€.aæ–‡ä»¶ã€version.txtã€LICENSEæ–‡ä»¶æ‰“åŒ…æˆzipï¼š
ZIPFILE=libtorch_ios_nightly_build.zip
cd ${ZIP_DIR}
#for testing
touch version.txt
echo $(date +%s) > version.txt
zip -r ${ZIPFILE} install src version.txt LICENSE
ä¸Šä¼ åˆ°awsï¼š
brew install awscli
export AWS_ACCESS_KEY_ID=${AWS_S3_ACCESS_KEY_FOR_PYTORCH_BINARY_UPLOAD}
export AWS_SECRET_ACCESS_KEY=${AWS_S3_ACCESS_SECRET_FOR_PYTORCH_BINARY_UPLOAD}
aws s3 cp ${ZIPFILE} s3://ossci-ios-build/ --acl public-read
è‡ªå·±ç¼–è¯‘iOSä¸Šçš„PyTorchåº“
1ï¼Œå…ˆå®‰è£…anaconda
æ¨èä½¿ç”¨condaï¼Œå¯¹äºæ··åˆpythonåº“å’ŒäºŒè¿›åˆ¶åº“çš„ç®¡ç†å¾ˆä¼˜ç§€ã€‚ä¸‹é¢æ‰€æœ‰çš„pythonç¯å¢ƒå’Œå‘½ä»¤éƒ½æ˜¯åœ¨condaä¸‹ã€‚ä½ å¯ä»¥ä½¿ç”¨å®˜æ–¹å®‰è£…çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å‚è€ƒä¸‹é¢çš„å‘½ä»¤è¡Œï¼š
curl --retry 3 -o ~/conda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh
chmod +x ~/conda.sh
/bin/bash ~/conda.sh -b -p ~/anaconda
export PATH="~/anaconda/bin:${PATH}"
source ~/anaconda/bin/activate
2ï¼Œå®‰è£…ä¾èµ–åŒ…
sudo pip install pyyaml
sudo pip install typing
3ï¼Œç¡®ä¿xcodebuildå·²ç»å®‰è£…
gemfield:~/github/CivilNet/pytorch$ command -v xcodebuild
/usr/bin/xcodebuild
4ï¼Œå…‹éš†PyTorchå®˜æ–¹ä»“åº“
å¦‚æœæ˜¯å…¨æ–°çš„å…‹éš†ï¼Œåˆ™æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤ï¼š
git clone --recursive https://github.com/pytorch/pytorch
å¦‚æœæœ‰å·²ç»å…‹éš†ä¸‹çš„PyTorchä»“åº“ï¼Œåˆ™åœ¨ä»“åº“ä¸­è¿è¡Œå¦‚ä¸‹æ›´æ–°å‘½ä»¤ï¼š
git submodule sync
git submodule update --init --recursive
5ï¼Œç¼–è¯‘XCodeçš„iOSæ¨¡æ‹Ÿå™¨ç”¨çš„åº“
åœ¨ä»“åº“æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œï¼š
BUILD_PYTORCH_MOBILE=1 IOS_PLATFORM=SIMULATOR ./scripts/build_ios.sh
6ï¼Œç¼–è¯‘XCodeçš„arm64æ¶æ„çš„åº“
åœ¨ä»“åº“æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œï¼š
BUILD_PYTORCH_MOBILE=1 IOS_ARCH=arm64 ./scripts/build_ios.sh
å¦‚ä½•åœ¨XCodeä¸Šä½¿ç”¨åˆšåˆšç¼–è¯‘çš„PyTorchåº“
1ï¼Œåœ¨XCodeä¸Šæ‰“å¼€ä½ çš„é¡¹ç›®ï¼Œæ‹·è´æ‰€æœ‰çš„é™æ€åº“å’Œå¤´æ–‡ä»¶åˆ°ä½ çš„é¡¹ç›®ä¸­ã€‚åœ¨project settingsä¸­ï¼Œè®¾ç½®Header Search Pathsä¸ºä½ åˆšåˆšæ‹·è´çš„å¤´æ–‡ä»¶çš„è·¯å¾„ï¼›
2ï¼Œåœ¨XCodeé¡¹ç›®çš„build settingsä¸­ï¼Œæ‰¾åˆ°other linker flagsï¼Œæ·»åŠ å¦‚ä¸‹çš„linkå‚æ•°ï¼š
-force_load $(PROJECT_DIR)/${path-to-libtorch.a}
3ï¼Œä¸ºtargetç¦ç”¨bitcodeï¼Œé€‰æ‹©é¡¹ç›®çš„Build Settings, æ‰¾åˆ°Enable Bitcode, è®¾ç½®å…¶å€¼ä¸ºNo.
æ€»ç»“
åœ¨åç»­çš„æ–‡ç« ä¸­ï¼ŒGemfieldè¿˜å°†ä»‹ç»iOSæ„å»ºçš„PyTorchåº“çš„è¯¦ç»†ç¼–è¯‘å•å…ƒç»„æˆï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå†ä»‹ç»ä¸‹è‡ªå®šä¹‰operatorçš„ç¼–è¯‘ï¼Œä»¥è¾¾åˆ°å‡å°‘é™æ€åº“å¤§å°çš„ç›®çš„ï¼ˆå½“ç„¶å‡å¹…ä¸æ˜¯å¾ˆå¤§ï¼‰ã€‚
