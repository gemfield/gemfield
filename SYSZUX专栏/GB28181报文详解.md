# 背景
本文将详细描述一些常见的GB28181报文，包括注册（REGISTER）、注销（REGISTER）、心跳（Keepalive）、INVITE、云台控制（PTZ）；并且针对海康、大华品牌的IPC分别在同网和跨网（跨路由器）的情况下进行分析。

文中，国标IPC的IP为192.168.10.8，IPC本地SIP端口为60719，SIP ID为34020000002000000719；SIP服务器的IP为192.168.10.10，SIP服务器的端口为57030，SIP ID为34020000002000000001。整个国标信令部分基于UDP协议进行传输。开发基于resiprocate库。

# 名词解释
1，SIP URI：是指一个用户的SIP电话号。SIP URI和e-mail地址格式类似，格式为sip:x@y:Port；

2，SIP Status messages （SIP状态信息）：

SIP状态信息使用数值100-699表示不同的含义：
```text
100-199：Used to indicate a temporary status, such as “100 Trying” or “180 Ringing”
200-299：Used to indicate a final success status, such as “200 OK”
300-399：Used to indicate a final failure status, but with information about the user’s new location, or about alternative services that might be able to answer the call. These are typical responses generated by SIP phones when the “Forward All Calls” or “Do Not Disturb” features (on the phone) are enabled.
400-499：Used to indicate a final error status, but local to the SIP Proxy generating this message – indicating that it may be possible that some other SIP Proxy may be in a position to successfully handle the request.
500-599：Used to indicate that the SYSZUX28181 Server has encountered an internal error. Examples are “500 Server Internal Error” and “501 Not Implemented”
600-699：Used to indicate a final error status, and that this status is global in nature – indicating that the request will in no case be able to be handled by some other SIP Proxy.
```
3，AOR：Address Of Record；

# 报文Header的关键字段
Request-Line-URI:

包含了一个Call的目的地，它应该是和To字段类似，只不过会忽略display name。

Via:

request路径上的每个proxy，在收到消息的时候，会在消息Via字段的顶部加上当前proxy的地址和端口；当处理response时，return路径上的每个proxy会倒过来处理Via字段，并且从Via字段的顶部依次去掉当前proxy的地址和端口。

From:

From字段表明最初的request方的身份，和To字段相似，它包含一个URI和一个可选的display name。根据SIP RFC 3261，From字段允许一个display name。当一个UAC (比如一个电话，或一个国标摄像机)想要隐藏身份信息时，应该使用“Anonymous”作为display name , 比如：
```bash
From: “Anonymous” <sip:10719@10.172.0.2>
```
To:

To字段是request的目的地AOR，格式和From一样，也允许使用display name，比如：
```xml
To: “Gemfield CivilNet” <sip:7030@10.172.0.2>
```
一般来说，“To”字段包含的SIP URI指向了第一个（或下一个）proxy，而不一定是最终接收方。

Contact:

Contact字段提供了一个单独的SIP URI，用以说明如何在后续的request中联系到INVITE的发送者。在可能导致建立起dialog的request消息中，Contact字段必须存在且仅包含一个SIP URI，这种情况下，尤其是SIP INVITE，这个contact的作用域是全局的，也就是说，Contact字段包含的URI不仅是sender期望接收request的地址，同时URI甚至在dialog之外的后续request中也是有效的。

Allow:

这个字段是使用逗号分割的一个list，指明了调用者支持或使用的SIP方法。SIP标准定义了这些方法: ACK, BYE, CANCEL, INFO, INVITE, NOTIFY, OPTIONS, PRACK, REFER, REGISTER, SUBSCRIBE, UPDATE。这些方法的定义如下：
```text
ACK：Used to reply to a SIP Status message in the range 200-699 while in a SIP INVITE dialog.
BYE：Used to end an already-established session, such as a SIP INVITE-based call.
CANCEL：Used to cancel a request (such as an INVITE or call request that is still in progress but unanswered)
INFO：Used to provide additional signaling, not necessarily related to a call in progress. SIP INFO Messages are typically used to provide notification of DTMF strokes (even though RFC 2833 type notifications are preferred), and is also one method used to establish MWI (message waiting indicator) functionality to SIP phones.
INVITE：Used to initiate a session dialog – typically to set up a phone call
NOTIFY：Used by the SYSZUX28181 Server to communicate statistics, typically to a SIP phone or GB28181 IPC.
OPTIONS：Used by a SIP client to query another SIP client or SIP proxy (such as the SYSZUX28181 Server) about its capabilities to discover information about the supported methods, content types, extensions, codecs, and so on, prior to, for example, establishing a call using the SIP INVITE method.
PRACK：Not used in SYSZUX28181 system.
REFER：Used by a SIP client to subscribe for notification of changes in call flow, for instance. Typically seen when a phone requests to transfer a call to another party.
REGISTER：Used to register or unregister a SIP user-agent with a SIP registrar. An unREGISTERed phone CANNOT receive a SIP INVITE Request to receive a call.
SUBSCRIBE：Used by a SIP Phone to establish a SIP dialog for receiving statistics. A typical example is MWI information for the phone’s configured Extension Number.
UPDATE：Not used in SYSZUX28181 System.
```
# 第1回合：注册 REGISTER
## 海康+同网

1，首先IPC会发送不带账户信息的注册请求：
```xml
REGISTER sip:34020000002000000001@3402000000 SIP/2.0
Via: SIP/2.0/UDP 192.168.10.8:60719;rport=60719;branch=z9hG4bK1377739937
Max-Forwards: 70
Contact: <sip:34020000002000000719@192.168.10.8:60719>
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000719@3402000000>;tag=1534571172
Call-ID: 1566767517
CSeq: 1 REGISTER
Expires: 3600
User-Agent: IP Camera
Content-Length: 0
```
注意这几个关键的信息：
```xml
Via: SIP/2.0/UDP 192.168.10.8:60719
rport=60719
Contact: <sip:34020000002000000719@192.168.10.8:60719>
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000719@3402000000>
Call-ID: 1566767517
CSeq: 1 REGISTER
Expires: 3600
```
2，SIP server 会进行鉴权，上述REGISTER消息的到来，会导致resiprocate使用resip::ServerAuthManager类的如下方法（一般会自己进行override）进行鉴权：
```xml
proxyAuthenticationMode //gemfield just return false;
requiresChallenge // gemfield just return true, means need challenge;
proxyAuthenticationMode //gemfield just return false;
useAuthInt // gemfield just return true;
```
因为没有携带鉴权信息，会导致返回401 Unauthorized：
```xml
SIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.10.8:60719;rport=60719;branch=z9hG4bK1377739937
To: <sip:34020000002000000719@3402000000>;tag=a9ced173
From: <sip:34020000002000000719@3402000000>;tag=1534571172
Call-ID: 1566767517
CSeq: 1 REGISTER
User-Agent: SYSZUX28181
WWW-Authenticate: Digest nonce="1577261948:e7c287426affd7479e0b017b20aa6690",algorithm=MD5,realm="3402000000",qop="auth,auth-int"
Content-Length: 0
```
3，国标IPC紧跟着会发送带鉴权信息的REGISTER消息
```xml
REGISTER sip:34020000002000000001@3402000000 SIP/2.0
Via: SIP/2.0/UDP 192.168.10.8:60719;rport=60719;branch=z9hG4bK1307786573
Max-Forwards: 70
Contact: <sip:34020000002000000719@192.168.10.8:60719>
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000719@3402000000>;tag=1534571172
Call-ID: 1566767517
CSeq: 2 REGISTER
Expires: 3600
User-Agent: IP Camera
Authorization: Digest username="34020000002000000719", realm="3402000000", nonce="1577261948:e7c287426affd7479e0b017b20aa6690", uri="sip:34020000002000000001@3402000000", response="d588f21ffa1efabdd5baed3950008a41", algorithm=MD5, cnonce="0a4f113b", qop=auth, nc=00000001
Content-Length: 0
```
注意这几个关键的信息：
```xml
Via: SIP/2.0/UDP 192.168.10.8:60719
rport=60719
Contact: <sip:34020000002000000719@192.168.10.8:60719>
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000719@3402000000>
Call-ID: 1566767517
CSeq: 2 REGISTER
Expires: 3600
```
和第一次REGISTER的相同点：Via、rport、Contact、To、From、Call-ID、Expires都完全一样；不同点：CSeq值增1、多了一个Authorization字段。

4，SIP server 会进行鉴权，上述REGISTER消息的到来，会导致resiprocate使用resip::ServerAuthManager类的如下方法（一般会自己进行override）进行鉴权：
```xml
proxyAuthenticationMode //gemfield just return false;
requestCredential // gemfield post UAI into dum_;
proxyAuthenticationMode //gemfield just return false;
authorizedForThisIdentity //
onAuthSuccess //
```
在注册成功之后，就开始使用resip::ServerRegistrationHandler类的如下方法来处理注册消息：

onAdd
然后你就可以开发自己的逻辑来响应这个注册消息了，至少要使用resip::ServerRegistration类来构建响应消息：
```xml
resip::ServerRegistration *h;
h->reject( 400 );
//or
resip::SipMessage success;
resip::Helper::makeResponse(success, *msg, 200);
success.header(resip::h_Expires) = msg->header(resip::h_Expires);
......
h->accept(success);
```
## 海康+跨网

在这个测试上下文中，Gemfield使IPC和SYSZUX28181 server之间跨越了一个TP-LINK路由器，SYSZUX28181 sip server的IP是192.168.1.5，TP-LINK的WAN口IP为192.168.1.10，IPC接在TP-LINK上，IP为192.168.5.126或者192.168.5.127。接下来gemfield用几句话简单介绍下NAT，NAT有以下几种：

- 完全圆锥型NAT（Full Cone NAT），内网设备GEM连接公网设备FIELD后，NAT打开一个端口，以后公网上任何发送到这个端口的数据（不限于FIELD）都可以访问到GEM，这个时候任何从公网上发过来的数据都可以通过该端口到达内网设备GEM，只限制的端口，没有限制ip地址；
- 地址限制圆锥型NAT（Address Restricted Cone NAT），内网设备GEM通过路由器连接了外网设备FIELD，NAT打开一个端口，这个时候外网设备FIELD（只限于FIELD）可以使用任何自身端口通过这个端口和内网设备GEM进行通信。限制了ip地址，没有限制端口；
- 端口限制圆锥型NAT(Port Restricted Cone NAT)，内网设备GEM通过路由器连接了外网设备FIELD，NAT打开一个端口，FIELD可以使用被访问的端口通过这个端口跟GEM进行通信，这种既限制了ip地址又限制了端口；
- 对称型NAT（Symmetric NAT），和Port Restricted Cone NAT相比，同一台内网设备与不同的外网设备通讯，NAT会打开不同的端口号——这就尴尬了，p2p的时候只能瞎猜测这个端口号了——以至于p2p没法在这种网络下使用；注意，client和server的直接交互不受影响。
- 跨网和同网在流程上一样，唯一的区别就是在Via字段上，跨网的时候多了一个“received=192.168.1.10”值（注意：这个值是resiprocate库添加上的，网络上传输的报文上是没有的，但是resiprocate一旦添加上，则返回给IPC的报文就包含了这个值）：
```xml
Via: SIP/2.0/UDP 192.168.10.8:60719;rport=60719;branch=z9hG4bK1377739937
Via: SIP/2.0/UDP 192.168.5.126:60719;rport=60719;branch=z9hG4bK1756581957;received=192.168.1.10
```
根据NAT规则，SYSZUX28181 server回IPC的报文，应该首先到达192.168.1.10的60719端口，也就是received + rport的组合。

## 大华+同网

大华的注册过程和海康同网在流程上一样，但是在字段的值上不一样，相形之下，海康更符合标准点（大华工程师要是不服的话，评论里可以和我辩论:-)。大华（后者）和海康（前者）的不同点如下所示：
```xml
REGISTER sip:34020000002000000001@3402000000 SIP/2.0
REGISTER sip:34020000002000000001@192.168.5.120:57030 SIP/2.0

NA
Route: <sip:34020000002000000719@192.168.5.120:57030;lr>

To: <sip:34020000002000000719@3402000000>
To: <sip:34020000002000000719@192.168.5.127:60719>

From: <sip:34020000002000000719@3402000000>;tag=1534571172
From: <sip:34020000002000000719@192.168.5.127:60719>;tag=1524182022

User-Agent: IP Camera
User-Agent: SIP UAS V3.0.0.722267

Authorization: Digest username="34020000002000000719", realm="3402000000", nonce="1577261948:e7c287426affd7479e0b017b20aa6690", uri="sip:34020000002000000001@3402000000", response="d588f21ffa1efabdd5baed3950008a41", algorithm=MD5, cnonce="0a4f113b", qop=auth, nc=00000001
Authorization: Digest username="34020000002000000719", realm="3402000000", nonce="1577552982:673e49744b32fd49b770bcb035a81a52", uri="sip:34020000002000000001@192.168.5.120:57030", response="ffccbc8b69bc8f9b7cef1c2b8ae00940", algorithm=MD5, cnonce="0a4f113b", qop=auth, nc=00000001
```
可以看到，大华IPC的特点是在Request-Line、To、From、Authorization字段上将SIP域的值换成了IP:PORT，而在Via、Contact等字段上是一样的。另外，还多了个Route: <sip:34020000002000000719@192.168.5.120:57030;lr>字段。

## 大华+跨网

可以看到，一是将海康的SIP域值换成了IP:Port，二是rport是6626，因为路由器已经为海康打开了60719：
```xml
REGISTER sip:34020000002000000001@192.168.1.5:57030 SIP/2.0
Via: SIP/2.0/UDP 192.168.5.127:60719;rport=6626;branch=z9hG4bK1528380693;received=192.168.1.10
Max-Forwards: 70
Route: <sip:34020000002610027030@192.168.1.5:57030;lr>
Contact: <sip:34020000002610027030@192.168.5.127:60719>
To: <sip:34020000002610027030@192.168.5.127:60719>
From: <sip:34020000002610027030@192.168.5.127:60719>;tag=1956614463
Call-ID: 1028641086
CSeq: 1 REGISTER
Expires: 3600
User-Agent: SIP UAS V3.0.0.722267
Content-Length: 0
```
# 第2回合：保活 Keepalive
## 海康+同网

国标IPC设备发送过来的心跳报文如下：
```xml
MESSAGE sip:34020000002000000001@3402000000 SIP/2.0
Via: SIP/2.0/UDP 192.168.10.8:60719;rport=60719;branch=z9hG4bK430967578
Max-Forwards: 70
To: <sip:34020000002000000001@3402000000>
From: <sip:34020000002000000719@3402000000>;tag=1555083253
Call-ID: 1910992793
CSeq: 20 MESSAGE
Content-Type: Application/MANSCDP+xml
User-Agent: IP Camera
Content-Length: 177

<?xml version="1.0" encoding="GB2312"?>
<Notify>
<CmdType>Keepalive</CmdType>
<SN>42</SN>
<DeviceID>34020000002000000719</DeviceID>
<Status>OK</Status>
<Info>
</Info>
</Notify>
```
resip::ServerPagerMessageHandler收到消息后，会调用onMessageArrived方法来处理；onMessageArrived要处理的message有很多种，心跳报文只是其中一种。这里的基本思路是根据message的body（xml格式）解析其中的tag，然后做对应的处理。

有时候，基于resiprocate构建的sip服务器首先会发送Trying报文：
```xml
SIP/2.0 100 Trying
Via: SIP/2.0/UDP 192.168.10.8:60719;rport=60719;branch=z9hG4bK430967578
To: <sip:34020000002000000001@3402000000>
From: <sip:34020000002000000719@3402000000>;tag=1555083253
Call-ID: 1910992793
CSeq: 20 MESSAGE
Content-Length: 0
```
然后才会发送200 OK：
```xml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.10.8:60719;rport=60719;branch=z9hG4bK430967578
To: <sip:34020000002000000001@3402000000>;tag=725a3c13
From: <sip:34020000002000000719@3402000000>;tag=1555083253
Call-ID: 1910992793
CSeq: 20 MESSAGE
User-Agent: SYSZUX28181
Content-Length: 0
```
## 海康+跨网

和Register一样。

## 大华+同网

大华和海康的区别除了前面描述过的 SIP域 vs IP:Port 区别之外，还体现在了Keepalive的xml body的区别：
```xml
<Notify>
<CmdType>Keepalive</CmdType>
<SN>42</SN>
<DeviceID>34020000002000000719</DeviceID>
<Status>OK</Status>
<Info>
</Info>
</Notify>

<?xml version="1.0" encoding="GB2312" ?>
<Notify>
    <CmdType>Keepalive</CmdType>
    <SN>0</SN>
    <DeviceID>34020000002000000719</DeviceID>
    <Status>OK</Status>
</Notify>
```
也就是说，大华body里加了tab或空格缩进，并且少了Info字段。

## 大华+跨网

同样被resiprocate库加上了received字段：
```xml
MESSAGE sip:34020000002000000001@192.168.1.5:57030 SIP/2.0
Via: SIP/2.0/UDP 192.168.5.127:60719;rport=6626;branch=z9hG4bK251482186;received=192.168.1.10
Max-Forwards: 70
To: <sip:34020000002000000001@192.168.1.5:57030>
From: <sip:34020000002610027030@192.168.5.127:60719>;tag=409887143
Call-ID: 1567395677
CSeq: 20 MESSAGE
Content-Type: Application/MANSCDP+xml
User-Agent: SIP UAS V3.0.0.722267
Content-Length: 180

<?xml version="1.0" encoding="GB2312" ?>
<Notify>
    <CmdType>Keepalive</CmdType>
    <SN>972</SN>
    <DeviceID>34020000002610027030</DeviceID>
    <Status>OK</Status>
</Notify>
```
# 第3回合：PTZ控制
## 海康+同网

以IPC的ptz中的向右转动为例，SIP server发出的SIP消息如下：

```xml
MESSAGE sip:34020000002000000719@192.168.10.8:60719;transport=UDP SIP/2.0
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---7d34c376f1e5486d;rport
Max-Forwards: 70
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000001@3402000000>;tag=aef07626
Call-ID: lWhu4s44gpzHXmvyiy69lw..
CSeq: 2 MESSAGE
Allow: REGISTER, INVITE, MESSAGE, ACK, BYE, CANCEL, INFO, SUBSCRIBE, NOTIFY
Content-Type: Application/MANSCDP+xml
User-Agent: SYSZUX28181
Content-Length: 225

<?xml version="1.0"?>
<Control>
<CmdType>DeviceControl</CmdType>
<SN>2</SN>
<DeviceID>34020000002000000719</DeviceID>
<PTZCmd>A50F0A01818100C1</PTZCmd>
<Info>
<ControlPriority>5</ControlPriority>
</Info>
</Control>
```
在这个报文中，值得注意的部分有：
```xml
Request-Line部分。其值是“MESSAGE sip:34020000002000000719@192.168.10.8:60719;transport-UDP SIP/2.0"，这里面包含了3部分，User Part是34020000002000000719，Host Part是192.168.10.8，Host port是60719；
Via: SIP/2.0/UDP 172.17.0.2:57030；这是SIP server所在的容器的IP（区别于宿主机的IP 192.168.10.10）；
To: <sip:34020000002000000719@3402000000>；
From: <sip:34020000002000000001@3402000000>；
Call-ID: lWhu4s44gpzHXmvyiy69lw；
CSeq: 2；
```
然后body中的xml内容描述了ptz控制的参数。

然后摄像头IPC回复200 OK：
```xml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---7d34c376f1e5486d;rport=57030;received=192.168.10.10
To: <sip:34020000002000000719@3402000000>;tag=534027144
From: <sip:34020000002000000001@3402000000>;tag=aef07626
Call-ID: lWhu4s44gpzHXmvyiy69lw..
CSeq: 2 MESSAGE
User-Agent: IP Camera
Content-Length: 0
```
## 海康+跨网

注意request line中的地址，已经变成了received + rport的组合。
```xml
MESSAGE sip:34020000002000000719@192.168.1.10:60719;transport=UDP SIP/2.0
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---a658a0444d5c4e66;rport
Max-Forwards: 70
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000001@3402000000>;tag=77afa251
Call-ID: 0ub4jHy0qmAJ4XpdbNV0Zw..
CSeq: 2 MESSAGE
Allow: REGISTER, INVITE, MESSAGE, ACK, BYE, CANCEL, INFO, SUBSCRIBE, NOTIFY
Content-Type: Application/MANSCDP+xml
User-Agent: SYSZUX28181
Content-Length: 225

<?xml version="1.0"?>
<Control>
<CmdType>DeviceControl</CmdType>
<SN>2</SN>
<DeviceID>34020000002000000719</DeviceID>
<PTZCmd>A50F0A01818100C1</PTZCmd>
<Info>
<ControlPriority>5</ControlPriority>
</Info>
</Control>
```

## 大华+同网

因为消息是由SYSZUX28181 server构建的，因此发送的消息都一样。而令人称奇的是，摄像头响应的response也一样，也就是大华的摄像头这次使用的是SIP域，而非IP:Port：
```xml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---670126760357736c;rport=57030;received=192.168.5.120
To: <sip:34020000002000000719@3402000000>;tag=1593128029
From: <sip:34020000002000000001@3402000000>;tag=f21a3c6b
Call-ID: CTGnTa4GEtwzfVzwBkm1lA..
CSeq: 2 MESSAGE
User-Agent: SIP UAS V3.0.0.722267
Content-Length: 0
```
## 大华+跨网

注意request-line上的rport的区别：
```xml
MESSAGE sip:34020000002610027030@192.168.1.10:6626;transport=UDP SIP/2.0
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---4119157c627d9600;rport
Max-Forwards: 70
To: <sip:34020000002610027030@3402000000>
From: <sip:34020000002000000001@3402000000>;tag=36c7c40c
Call-ID: MF5dxttskwkTEISUAkpb2Q..
CSeq: 2 MESSAGE
Allow: REGISTER, INVITE, MESSAGE, ACK, BYE, CANCEL, INFO, SUBSCRIBE, NOTIFY
Content-Type: Application/MANSCDP+xml
User-Agent: SYSZUX28181
Content-Length: 225

<?xml version="1.0"?>
<Control>
<CmdType>DeviceControl</CmdType>
<SN>1</SN>
<DeviceID>34020000002610027030</DeviceID>
<PTZCmd>A50F0A02818100C2</PTZCmd>
<Info>
<ControlPriority>5</ControlPriority>
</Info>
</Control>
```
# 第4回合：INVITE消息
大家都知道，像SYSZUX28181这样的SIP系统，包含两大部分，一是SIP信令部分，二是真正的媒体数据的传输（如audio、video或者两者都有）。而在这两部分之间建立起一座桥梁的，就是SDP协议了——SDP内容包含在SIP invite信令中，用以描述media数据如何传输（比如媒体服务器的地址、传输协议、编码、端口和其它一些metadata）。也因此，我们要在INVITE这一回合中详细介绍下SDP。

SDP是Session Description Protocol的缩写，本身并不提供媒体服务，它只是描述了媒体服务在哪，以及如何和那个媒体服务打交道。SDP由3部分组成，第1部分是Session description，有如下字段：
```xml
v= (protocol version)，根据RFC 4566，到目前只有0；
o= (owner/creator and session identification)，格式为<username><sess-id><sess-version><nettype><addrtype><unicast-address>；
s= (session name)，一个session一个；
i= (session information)*
u= (URI of description)*
e=(email address – contact detail)*
p= (phone number – contact detail)*，Specifies contact information for the person responsible for the conference；
c= (connection information – not required if included in media description)*，格式为<nettype> <addrtype> <connection-address>；
b= (session bandwidth information)*
z= (time zone adjustments)*
k= (encryption key)*
a= (zero or more session attribute lines)*，格式为<attribute>:<value>；
```
第2部分是Time description，有如下字段：
```xml
t= (time the session is active)，格式<start-time>:<value>；
r= (repeat times)*，格式<repeat interval> <active duration> <offsets from start-time>；
```
第3部分是Media description，有如下字段：
```xml
m= (media name/ transport address)，格式<media> <port>/<number of ports> <proto> <fmt>；
i= (media title)*
c= (connection information – not required if included in session description)*
b= (bandwidth information)*
k= (encryption key)*
a= (zero or more media attribute lines)*，格式为<attribute>:<value>；
```
## 海康+同网

发送INVITE消息到IPC，IPC会先返回trying，然后会返回200 OK。
```xml
INVITE sip:34020000002000000719@192.168.10.8:60719;transport=UDP SIP/2.0
Via: SIP/2.0/ ;branch=z9hG4bK-524287-1---3d3fa662632a7a58;rport
Max-Forwards: 70
Contact: <sip:34020000002000000001>
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000001@3402000000>;tag=a8de8e37
Call-ID: Todht0cMF4NZadf4bA86bw..
CSeq: 1 INVITE
Subject: 34020000002000000719:000000719,34020000002000000001:0
Allow: REGISTER, INVITE, MESSAGE, ACK, BYE, CANCEL, INFO, SUBSCRIBE, NOTIFY
Content-Type: APPLICATION/SDP
User-Agent: SYSZUX28181
Content-Length: 221

v=0
o=34020000002000000719 0 0 IN IP4 192.168.10.10
s=Play
c=IN IP4 192.168.10.10
t=0 0
m=video 5060 RTP/AVP 96 97 98
a=recvonly
a=rtpmap:96 PS/90000
a=rtpmap:97 H264/90000
a=rtpmap:98 MPEG4/90000
y=1760090202
```
再补充介绍下几个复杂的字段：

1，o字段，格式为<username><sess-id><sess-version><nettype><addrtype><unicast-address>，也就是这里的34020000002000000719 0 0 IN IP4 192.168.10.10：
```xml
<username> – The user’s login. 不能有空格，这里是34020000002000000719；
<sess-id> – A numeric string used as unique identifier for the session，这里是0；
<sess-version> – A numeric string used as version number for this session description，这里是0；
<nettype> – Text string, specifying the network type, e.g. IN for internet，这里是IN；
<addrtype> – Text string specifying the type of the address of originator E.g.IP4 or IP6；
<unicast-address> – The address of the machine from where the session is originating, which can be both FQDN or IP address，这里是192.168.10.10；
```
2，c字段，说的是connection信息，格式为<nettype> <addrtype> <connection-address>，也就是这里的 IN IP4 192.168.10.10。
```xml
<nettype> ，A text string describing the network type, e.g. IN for internet；上面提到过了；
<addrype> A text string describing the type of the address used in connection-address; E.g. IP4 or IP6，上面也提到过了；
<connection-address> A Multicast IP address is specified including TTL, e.g. 224.2.36.42/127，这里是192.168.10.10；
```
3，m字段，描述media的（比如端口，协议，编码等），格式为<media> <port>/<number of ports> <proto> <fmt>，这里为video 5060 RTP/AVP 96 97 98：
```xml
<media> Used to specify media type, generally this can be audio, video, text etc，这里是video；
<port> The port to which the media stream will be sent. Multiple ports can also be specified if more than 1 port is being used，这里是5060；
<proto> The transport protocol used for streaming, e.g. RTP (real time protocol)，这里是RTP/AVP，是RTP A/V Profile的缩写；RTSP流(传输RTP包)的传输方式有两种：RTP/AVP/UDP和RTP/AVP/TCP，默认传输方式为：RTP/AVP， 即RTP/AVP/UDP ；
<fmt> The format of the media being sent, e.g. in which codec is the media encoded; e.g. PCMU, GSM etc，这里是96 97 98；
```
4，a字段，格式为<attribute>:<value>，代表Attributes，可以定义在“session-level”或者“media-level” ，或者两处都定义。Media level的attributes只定义media相关的，这里是：
```xml
a=recvonly，（也有其它的值，比如sendrecv等）
a=rtpmap:96 PS/90000
a=rtpmap:97 H264/90000
a=rtpmap:98 MPEG4/90000
```
海康IPC会先发送Trying消息：
```xml
SIP/2.0 100 Trying
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---3d3fa662632a7a58;rport=57030;received=192.168.10.10
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000001@3402000000>;tag=a8de8e37
Call-ID: Todht0cMF4NZadf4bA86bw..
CSeq: 1 INVITE
User-Agent: IP Camera
Content-Length: 0
```
海康IPC然后会发送200 OK消息：
```xml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---3d3fa662632a7a58;rport=57030;received=192.168.10.10
Contact: <sip:34020000002000000719@192.168.10.8:60719>
To: <sip:34020000002000000719@3402000000>;tag=1551900522
From: <sip:34020000002000000001@3402000000>;tag=a8de8e37
Call-ID: Todht0cMF4NZadf4bA86bw..
CSeq: 1 INVITE
Content-Type: application/sdp
User-Agent: IP Camera
Content-Length: 183

v=0
o=34020000002000000719 698 698 IN IP4 192.168.10.8
s=Play
c=IN IP4 192.168.10.8
t=0 0
m=video 15060 RTP/AVP 96
a=sendonly
a=rtpmap:96 PS/90000
a=filesize:0
y=1760090202
```
## 海康+跨网

如下所示：
```xml
INVITE sip:34020000002000000719@192.168.1.10:60719;transport=UDP SIP/2.0
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---fb6e7d481b46b357;rport
Max-Forwards: 70
Contact: <sip:34020000002000000001@172.17.0.2:57030>
To: <sip:34020000002000000719@3402000000>
From: <sip:34020000002000000001@3402000000>;tag=14ef4a54
Call-ID: KwvgT_AyR5Hg01d5zMHQNw..
CSeq: 1 INVITE
Subject: 34020000002000000719:000000719,34020000002000000001:0
Allow: REGISTER, INVITE, MESSAGE, ACK, BYE, CANCEL, INFO, SUBSCRIBE, NOTIFY
Content-Type: APPLICATION/SDP
User-Agent: SYSZUX28181
Content-Length: 221

v=0
o=34020000002000000719 0 0 IN IP4 192.168.1.5
s=Play
c=IN IP4 192.168.1.5
t=0 0
m=video 5060 TCP/RTP/AVP 96 97 98
a=recvonly
a=rtpmap:96 PS/90000
a=rtpmap:97 H264/90000
a=rtpmap:98 MPEG4/90000
y=1760090202
```
海康摄像头回复200 OK
```xml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---fb6e7d481b46b357;rport=57030;received=192.168.1.5
Contact: <sip:34020000002000000719@192.168.1.10:60719>
To: <sip:34020000002000000719@3402000000>;tag=465224665
From: <sip:34020000002000000001@3402000000>;tag=14ef4a54
Call-ID: KwvgT_AyR5Hg01d5zMHQNw..
CSeq: 1 INVITE
Content-Type: application/sdp
User-Agent: IP Camera
Content-Length: 207

v=0
o=34020000002000000719 1261 1261 IN IP4 192.168.5.126
s=Play
c=IN IP4 192.168.5.126
t=0 0
m=video 15060 TCP/RTP/AVP 96
a=setup:active
a=sendonly
a=rtpmap:96 PS/90000
a=filesize:0
y=1760090202
```
## 大华+同网

类似，不再赘述。

## 大华+跨网

如下所示：
```xml
INVITE sip:34020000002610027030@192.168.1.10:6626;transport=UDP SIP/2.0
Via: SIP/2.0/ ;branch=z9hG4bK-524287-1---cce9ed650eea2b1a;rport
Max-Forwards: 70
Contact: <sip:34020000002000000001>
To: <sip:34020000002610027030@3402000000>
From: <sip:34020000002000000001@3402000000>;tag=1bcbe761
Call-ID: 6HcoGloZQgJ6YRY_STg-1w..
CSeq: 1 INVITE
Subject: 34020000002610027030:010027030,34020000002000000001:0
Allow: REGISTER, INVITE, MESSAGE, ACK, BYE, CANCEL, INFO, SUBSCRIBE, NOTIFY
Content-Type: APPLICATION/SDP
User-Agent: SYSZUX28181
Content-Length: 221

v=0
o=34020000002610027030 0 0 IN IP4 192.168.1.5
s=Play
c=IN IP4 192.168.1.5
t=0 0
m=video 5060 TCP/RTP/AVP 96 97 98
a=recvonly
a=rtpmap:96 PS/90000
a=rtpmap:97 H264/90000
a=rtpmap:98 MPEG4/90000
y=1760090203
```
大华摄像头回复：
```xml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 172.17.0.2:57030;branch=z9hG4bK-524287-1---cce9ed650eea2b1a;rport=57030;received=192.168.1.5
Contact: <sip:34020000002610027030@192.168.5.127:60719>
To: <sip:34020000002610027030@3402000000>;tag=523350899
From: <sip:34020000002000000001@3402000000>;tag=1bcbe761
Call-ID: 6HcoGloZQgJ6YRY_STg-1w..
CSeq: 1 INVITE
Content-Type: application/sdp
User-Agent: SIP UAS V3.0.0.722267
Content-Length: 264

v=0
o=34020000002610027030 0 0 IN IP4 192.168.5.127
s=Play
i=VCam Live Video
c=IN IP4 192.168.5.127
t=0 0
m=video 9704 TCP/RTP/AVP 96
a=sendonly
a=rtpmap:96 PS/90000
a=streamprofile:0
a=setup:active
a=connection:new
y=1760090203
f=v/0/0/0/0/0a/0/0/0
```
